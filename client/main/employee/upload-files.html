<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SecureFile</title>
    <link
      rel="shortcut icon"
      type="image/png"
      href="../../../assets/img/logo.png"
    />
    <link rel="stylesheet" href="../../../assets/css/styles.min.css" />
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <!--  Body Wrapper -->
    <div
      class="page-wrapper"
      id="main-wrapper"
      data-layout="vertical"
      data-navbarbg="skin6"
      data-sidebartype="full"
      data-sidebar-position="fixed"
      data-header-position="fixed"
    >
      <!-- Sidebar Start -->
      <aside class="left-sidebar">
        <!-- Sidebar scroll-->
        <div>
          <div
            class="brand-logo d-flex align-items-center justify-content-between"
          >
            <a href="./index.html" class="text-nowrap logo-img">
              <img src="../../../assets/img/light-logo-employee.svg" alt="" />
            </a>
            <div
              class="close-btn d-xl-none d-block sidebartoggler cursor-pointer"
              id="sidebarCollapse"
            >
              <i class="ti ti-x fs-8"></i>
            </div>
          </div>
          <!-- Sidebar navigation-->
          <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
            <ul id="sidebarnav">
              <li class="nav-small-cap">
                <i class="ti ti-dots nav-small-cap-icon fs-6"></i>
                <span class="hide-menu">Home</span>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./" aria-expanded="false">
                  <span>
                    <iconify-icon
                      icon="solar:home-smile-bold-duotone"
                      class="fs-6"
                    ></iconify-icon>
                  </span>
                  <span class="hide-menu">Dashboard</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a
                  class="sidebar-link"
                  href="./upload-files"
                  aria-expanded="false"
                >
                  <span>
                    <iconify-icon
                      icon="solar:upload-minimalistic-bold-duotone"
                      class="fs-6"
                    ></iconify-icon>
                  </span>
                  <span class="hide-menu">Upload Files</span>
                </a>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link" href="./my-files" aria-expanded="false">
                  <span>
                    <iconify-icon
                      icon="solar:layers-minimalistic-bold-duotone"
                      class="fs-6"
                    ></iconify-icon>
                  </span>
                  <span class="hide-menu">My Files</span>
                </a>
              </li>
            </ul>
          </nav>
          <!-- End Sidebar navigation -->
        </div>
        <!-- End Sidebar scroll-->
      </aside>
      <!--  Sidebar End -->
      <!--  Main wrapper -->
      <div class="body-wrapper">
        <!--  Header Start -->
        <header class="app-header">
          <nav class="navbar navbar-expand-lg navbar-light">
            <ul class="navbar-nav">
              <li class="nav-item d-block d-xl-none">
                <a
                  class="nav-link sidebartoggler nav-icon-hover"
                  id="headerCollapse"
                  href="javascript:void(0)"
                >
                  <i class="ti ti-menu-2"></i>
                </a>
              </li>
            </ul>
            <div
              class="navbar-collapse justify-content-end px-0"
              id="navbarNav"
            >
              <ul
                class="navbar-nav flex-row ms-auto align-items-center justify-content-end"
              >
                <li class="nav-item dropdown">
                  <a
                    class="nav-link nav-icon-hover"
                    href="javascript:void(0)"
                    id="drop2"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <img
                      src="../../../assets/images/profile/user-1.jpg"
                      alt=""
                      width="35"
                      height="35"
                      class="rounded-circle"
                    />
                  </a>
                  <div
                    class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up"
                    aria-labelledby="drop2"
                  >
                    <div class="message-body">
                      <a
                        href="../employee/profile-settings/profile-settings"
                        class="d-flex align-items-center gap-2 dropdown-item"
                      >
                        <i class="ti ti-user fs-6"></i>
                        <p class="mb-0 fs-3">My Profile</p>
                      </a>
                      <a
                        href="../../session/signout.php"
                        class="btn btn-outline-primary mx-3 mt-2 d-block"
                        >Logout</a
                      >
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </nav>
        </header>
        <!--  Header End -->
        <div class="container-fluid">
          <div class="row">
            <div class="col-lg-12 mt-3">
              <div class="card border-2">
                <div class="card-body text-center">
                  <div class="drag-area border-2 border-primary rounded p-5 text-center" id="drag-area">
                      <p class="mb-0">Drag & Drop files here or click to upload</p>
                      <input type="file" id="file-input" multiple style="display: none;">
                  <div
                    class="drag-area border-2 border-primary rounded p-4 text-center"
                    id="drag-area"
                  >
                    <p class="mb-0">
                      Drag & Drop files here or click to upload
                    </p>
                    <input
                      type="file"
                      id="file-input"
                      multiple
                      style="display: none"
                    />
                  </div>

                  <p id="file-count-indicator" class="mt-3">0/10 Files</p>
                  <ul id="file-list" class="list-group mt-2"></ul>
                  <button id="upload-btn" class="btn btn-success mb-3 mt-2">
                    Proceed to Upload
                  </button>
                </div>
              </div>
            </div>
            
            <div class="col-lg-12" style="display: none;">
              <div class="card">
                <div class="card-body">
                  <div class="row">
                    <h4 class="col-lg-12">Recently Uploaded Files</h4>
                    <div class="col-sm-8 text-start"></div>
                    <div class="col-sm-4 text-end">
                      <form method="get" onsubmit="return false;" class="mb-2">
                        <input
                          type="search"
                          class="form-control fs-3"
                          name="search"
                          id="search"
                          oninput="applyFilters()"
                          placeholder="Search File"
                        />
                      </form>
                    </div>
                  </div>

                  <!-- Table -->
                  <div class="col-lg-12 client-table">
                    <div class="table-responsive my-2">
                      <table
                        class="table text-nowrap align-middle mb-0"
                        id="fileTable"
                      >
                        <thead>
                          <tr
                            class="border-2 border-bottom border-primary border-0"
                          >
                            <th scope="col" class="ps-0">Filename</th>
                            <th scope="col" class="ps-0">File Size</th>
                            <th scope="col" class="ps-0">Upload Date</th>
                          </tr>
                        </thead>
                        <tbody
                          class="table-group-divider"
                          id="uploaded-files-table"
                        ></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for Alerts -->
    <div
      class="modal fade"
      id="alert-modal"
      tabindex="-1"
      aria-labelledby="alert-modalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="alert-modalLabel">Alert</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="modal-icon">
              <i id="modal-icon" class="fas fa-info-circle"></i>
            </div>
            <p id="modal-message">This is a sample message.</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-danger"
              id="alert-cancel-btn"
              style="display: none"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="alert-close-btn"
              data-bs-dismiss="modal"
            >
              Okay
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const dragArea = document.getElementById("drag-area");
        const fileInput = document.getElementById("file-input");
        const fileList = document.getElementById("file-list");
        const uploadButton = document.getElementById("upload-btn");
        const uploadedFilesTable = document.getElementById(
          "uploaded-files-table"
        );
        const fileCountIndicator = document.getElementById(
          "file-count-indicator"
        );
        const limitfile = 10;
        let uploadedFiles = [];
        let allFiles = new Set();

        // Function to create a progress bar
        function createProgressBar() {
          const progressBar = document.createElement("div");
          progressBar.className = "file-progress-bar";
          progressBar.innerHTML = `<div class="file-progress-fill"></div>`;
          return progressBar;
        }

        // Update the file count indicator
        function updateFileCountIndicator() {
          fileCountIndicator.textContent = `${uploadedFiles.length}/${limitfile} Files`;
        }

        // Drag & Drop Events
        dragArea.addEventListener("click", () => fileInput.click());
        dragArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          dragArea.classList.add("highlight");
        });
        dragArea.addEventListener("dragleave", () => {
          dragArea.classList.remove("highlight");
        });
        dragArea.addEventListener("drop", (e) => {
          e.preventDefault();
          dragArea.classList.remove("highlight");
          const files = e.dataTransfer.files;
          handleFiles(files);
        });

        // Function to show the modal with dynamic content
        function showModal(message, type, showCancelButton = false) {
          const modal = document.getElementById("alert-modal");
          const modalMessage = document.getElementById("modal-message");
          const modalIcon = document.getElementById("modal-icon");
          const alertCloseButton = document.getElementById("alert-close-btn");
          const cancelButton = document.getElementById("alert-cancel-btn");

          modalMessage.textContent = message;
          modalIcon.className = getIconByType(type);
          cancelButton.style.display = showCancelButton ? "block" : "none";

          $(modal).modal("show"); // Using Bootstrap's modal function to show the modal

          alertCloseButton.onclick = () => $(modal).modal("hide");
          if (showCancelButton) {
            cancelButton.onclick = () => $(modal).modal("hide");
          }
        }

        function getIconByType(type) {
          switch (type) {
            case "success":
              return "fas fa-check-circle";
            case "error":
              return "fas fa-times-circle";
            case "warning":
              return "fas fa-exclamation-triangle";
            case "info":
              return "fas fa-info-circle";
            default:
              return "fas fa-info-circle";
          }
        }

        // Function to handle file input changes
        fileInput.addEventListener("change", () => {
          handleFiles(fileInput.files);
          fileInput.value = ""; // Reset input
        });

        // Simulate Progress Bar for Each File Upload
        async function simulateFileUpload(fileObj) {
          const progressBarFill = fileObj.progressBar.querySelector(
            ".file-progress-fill"
          );
          const fileSize = fileObj.file.size; // Get file size in bytes

          let uploadSpeed = 1; // Default upload speed (1% per interval)

          // Adjust upload speed based on file size
          if (fileSize < 1024 * 1024) {
            // Small file (KB)
            uploadSpeed = 10; // Faster upload speed for smaller files
          } else if (fileSize < 1024 * 1024 * 10) {
            // Medium file (less than 10MB)
            uploadSpeed = 5; // Moderate upload speed for medium-sized files
          } else {
            // Larger files (MB and GB)
            uploadSpeed = 2; // Slower upload speed for larger files
          }

          return new Promise((resolve) => {
            let progress = 0;
            const interval = setInterval(() => {
              if (fileObj.canceled) {
                clearInterval(interval);
                progressBarFill.style.width = "0%"; // Reset progress bar
                return;
              }
              progress += Math.random() * uploadSpeed; // Increment progress
              progressBarFill.style.width = `${Math.min(progress, 100)}%`; // Update progress

              if (progress >= 100) {
                clearInterval(interval);
                resolve(); // Resolve the promise when upload is complete
              }
            }, 300); // Simulate upload every 300ms
          });
        }

        // Function to handle file validation and preparation
        function handleFiles(files) {
          for (let file of files) {
            // Check for duplicate files in the uploaded files list
            const isDuplicateInList = uploadedFiles.some(
              (uploadedFile) => uploadedFile.file.name === file.name
            );

            // Check for duplicates in the uploaded files table
            const isDuplicateInTable = Array.from(uploadedFilesTable.rows).some(
              (row) => {
                return row.cells[0].textContent === file.name; // Assuming the first cell contains the file name
              }
            );

            if (
              isDuplicateInList ||
              isDuplicateInTable ||
              allFiles.has(file.name)
            ) {
              // Show duplicate file modal
              showDuplicateFileModal(file);
              continue; // Skip adding the file until the user confirms
            }

            // Add the file to the list if it's not a duplicate
            addFileToList(file);
          }
        }

        // Function to add a file to the list
        function addFileToList(file) {
          // Allowed file types
          const allowedExtensions = [
            "pdf",
            "docx",
            "xlsx",
            "xls",
            "txt",
            "ppt",
            "pptx",
            "png",
            "jpg",
            "jpeg",
          ];

          // Extract the file extension
          const fileExtension = file.name.split(".").pop().toLowerCase();

          // Check if the file type is allowed
          if (!allowedExtensions.includes(fileExtension)) {
            showModal(
              "Only PDF, DOCX, Excel, TXT, PPTX/PPT, PNG, and JPG/JPEG files are allowed.",
              "error"
            );
            return;
          }

          if (uploadedFiles.length + 1 > limitfile) {
            showModal(
              `You can upload a maximum of ${limitfile} files.`,
              "warning"
            );
            return;
          }

          const listItem = document.createElement("li");
          listItem.className = "file-item";
          listItem.innerHTML = `  
                <span class="file-name">${file.name}</span>  
                <span class="file-size">${formatFileSize(file.size)}</span>  
                <div class="file-progress"></div>  
                <button class="remove-btn">X</button>  
            `;

          const progressBar = createProgressBar();
          listItem.querySelector(".file-progress").appendChild(progressBar);

          const removeButton = listItem.querySelector(".remove-btn");
          removeButton.addEventListener("click", () => {
            const fileObj = uploadedFiles.find((f) => f.file === file);
            if (fileObj) {
              fileObj.canceled = true;

              // Abort the upload request if it's in progress
              if (fileObj.controller) {
                fileObj.controller.abort(); // Abort the fetch request if uploading
              }

              showModal(`Upload for ${file.name} has been canceled.`, "cancel");
              // Remove file from list
              fileList.removeChild(listItem);
              uploadedFiles = uploadedFiles.filter((f) => f.file !== file);
              allFiles.delete(file.name); // Remove from set
              updateFileCountIndicator();
            }
          });

          fileList.appendChild(listItem);
          uploadedFiles.push({
            file,
            progressBar,
            active: true,
            uploading: false,
            canceled: false,
          });
          allFiles.add(file.name); // Add the file name to the set
          updateFileCountIndicator();
        }

        // Function to show the duplicate file modal
        function showDuplicateFileModal(file) {
          showModal(
            `The file "${file.name}" already exists. Are you sure you want to add it?`,
            "info",
            true
          );

          const alertCloseButton = document.getElementById("alert-close-btn");
          const cancelButton = document.getElementById("alert-cancel-btn");

          // Handle "Okay" button click
          alertCloseButton.onclick = () => {
            addFileToList(file); // Add the file to the list
            const modal = document.getElementById("alert-modal");
            modal.classList.remove("show"); // Hide the modal
          };

          // Handle "Cancel" button click
          cancelButton.onclick = () => {
            const modal = document.getElementById("alert-modal");
            modal.classList.remove("show"); // Hide the modal
          };
        }

        let uploadedFileNames = new Map();

        // Upload Files Button Event
        uploadButton.addEventListener("click", async () => {
          if (uploadedFiles.length === 0) {
            showModal("Please select at least one file to upload.", "info");
            return;
          }

          let successfulUploads = 0;
          const uploadPromises = []; // Array to store all upload promises

          // Simulate file upload and progress bar completion
          for (const fileObj of [...uploadedFiles]) {
            if (!fileObj.active || fileObj.canceled) {
              continue; // Skip inactive or canceled files
            }

            fileObj.uploading = true;

            // Handle duplicate filenames before uploading
            let originalFileName = fileObj.file.name;
            let fileName = originalFileName;

            if (uploadedFileNames.has(originalFileName)) {
              const count = uploadedFileNames.get(originalFileName) + 1;
              uploadedFileNames.set(originalFileName, count);
              const extIndex = fileName.lastIndexOf(".");
              if (extIndex !== -1) {
                const namePart = fileName.substring(0, extIndex);
                const extPart = fileName.substring(extIndex);
                fileName = `${namePart} (${count})${extPart}`;
              } else {
                fileName = `${fileName} (${count})`; // No extension case
              }
            } else {
              uploadedFileNames.set(originalFileName, 0); // First occurrence
            }

            // Create a new File object with the updated name if necessary
            const renamedFile = new File([fileObj.file], fileName, {
              type: fileObj.file.type,
            });

            // Create a promise for each file upload
            const uploadPromise = new Promise(async (resolve, reject) => {
              try {
                await simulateFileUpload(fileObj);

                if (fileObj.canceled) {
                  console.log(`Upload for ${fileObj.file.name} was canceled.`);
                  resolve(); // Resolve the promise even if canceled
                  return;
                }

                const formData = new FormData();
                formData.append("file", renamedFile); // Use the renamed file

                const response = await fetch("upload.php", {
                  method: "POST",
                  body: formData,
                });

                const result = await response.json();
                if (result.status === "success") {
                  successfulUploads++;

                  // Remove file from the DOM and list
                  const listItem = fileObj.progressBar.closest(".file-item");
                  if (listItem) {
                    listItem.remove(); // Remove the file item from the DOM
                  }
                  uploadedFiles = uploadedFiles.filter((f) => f !== fileObj); // Remove from the list
                  allFiles.delete(fileObj.file.name); // Remove from the set
                  updateFileCountIndicator(); // Update file count indicator

                  // Add the file details to the uploaded files table
                  addFileToTable(
                    fileName,
                    fileObj.file.size,
                    new Date().toLocaleString()
                  );
                  resolve(); // Resolve the promise after successful upload
                } else {
                  console.error("Error:", result.message);
                  reject(result.message); // Reject the promise if there's an error
                }
              } catch (error) {
                console.error("Upload failed:", fileObj.file.name, error);
                reject(error); // Reject the promise if there's an error
              }
            });

            uploadPromises.push(uploadPromise); // Add the promise to the array
          }

          // Wait for all uploads to complete
          Promise.allSettled(uploadPromises).then((results) => {
            // Show the modal after all uploads are complete
            showModal(
              `${successfulUploads} file(s) uploaded successfully!`,
              "success"
            );
          });
        });

        function addFileToTable(fileName, fileSize, uploadTime) {
          const row = document.createElement("tr");
          row.innerHTML = `
              <td>${fileName}</td>
              <td>${formatFileSize(
                fileSize
              )}</td> <!-- File size displayed as KB, MB, or GB -->
              <td>${uploadTime}</td>     
          `;
          uploadedFilesTable.appendChild(row);
        }

        // Function to format file size in KB, MB, or GB
        function formatFileSize(sizeInBytes) {
          if (sizeInBytes < 1024) {
            return `${sizeInBytes} B`;
          } else if (sizeInBytes < 1048576) {
            return (sizeInBytes / 1024).toFixed(2) + " KB";
          } else if (sizeInBytes < 1073741824) {
            return (sizeInBytes / 1048576).toFixed(2) + " MB";
          } else {
            return (sizeInBytes / 1073741824).toFixed(2) + " GB";
          }
        }
      });
    </script>
    <script>
      (function () {
        const checkSession = () => {
          fetch("../../session/sessioncheck.php", {
            method: "GET",
            credentials: "include", // Include cookies with the request
          })
            .then((response) => response.json())
            .then((data) => {
              if (!data.sessionValid) {
                // Redirect to the logout script if the session is invalid
                window.location.href = "../login?error=session_expired";
              }
            })
            .catch((err) => {
              console.error("Error checking session:", err);
              // Handle fetch errors if needed
            });
        };

        // Check the session every 5 minutes (300,000 milliseconds)
        setInterval(checkSession, 300000);

        // Also check the session immediately when the script is loaded
        checkSession();
      })();
    </script>
    <script src="../../../assets/libs/jquery/dist/jquery.min.js"></script>
    <script src="../../../assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../../assets/libs/apexcharts/dist/apexcharts.min.js"></script>
    <script src="../../../assets/libs/simplebar/dist/simplebar.js"></script>
    <script src="../../../assets/js/sidebarmenu.js"></script>
    <script src="../../../assets/js/app.min.js"></script>
    <script src="../../../assets/js/dashboard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
  </body>
</html>
